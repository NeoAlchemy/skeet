<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
        <script src="https://unpkg.com/aframe-environment-component/dist/aframe-environment-component.min.js"></script>
        <script>
            let targetedClayPigeon = null; // Variable to track the intersected clay pigeon

            AFRAME.registerComponent('shotgun-raycaster', {
              init: function () {
                const raycasterEl = this.el;
                
                // Event listener to detect intersection with objects
                raycasterEl.addEventListener('raycaster-intersection', function(event) {
                    console.log("rayCaster-intersection entered")
                    const intersects = event.detail.intersections;
                    if (intersects.length > 0 && intersects[0].object.el.classList.contains('collidable')) {
                        targetedClayPigeon = intersects[0].object.el;
                        console.log("Shotgun aimed at", targetedClayPigeon.id);
                    } else {
                    console.log("no target in line of sight")
                    targetedClayPigeon = null; // No target in line of sight
                    }
                });
              }
            });

            // Function to handle the shoot button click
            function shootClayPigeon() {
                document.getElementById('skeetFireEntity').components.sound.playSound();
                if (targetedClayPigeon) {
                    // Hide the clay pigeon if it was hit
                    targetedClayPigeon.setAttribute('visible', 'false');
                    targetedClayPigeon.removeAttribute('animation')
                    targetedClayPigeon.setAttribute('position', '-100, -100,')
                    setTimeout(() => {
                        document.getElementById('clayPigeonBreakEntity').components.sound.playSound();
                    }, 200);
                    console.log("Pigeon shot:", targetedClayPigeon.id);
                    targetedClayPigeon = null; // Reset after shooting
                } else {
                    console.log("No pigeon in sight");
                }
            }

            // Function to reset the game
            function resetGame() {
                // Reset all clay pigeons
                const pigeons = ['clayPigeon1', 'clayPigeon2', 'clayPigeon3'];
                
                pigeons.forEach(id => {
                    const pigeon = document.getElementById(id);
                    // Reset visibility
                    pigeon.setAttribute('visible', 'true');
                    
                    // Reset the positions and animations
                    if (id === 'clayPigeon1') {
                        pigeon.setAttribute('position', '-10 0 -20');
                        pigeon.setAttribute('animation__fall', 'property: position; from: 0 20 -25; dur: 3000; easing: easeInOutQuad; to: 10 0 -30; loop: true');
                        pigeon.setAttribute('animation__smaller', 'property: scale; dur: 3000; to: 0.1 0.1 0.1; loop: true');
                    } else if (id === 'clayPigeon2') {
                        pigeon.setAttribute('position', '-5 2 -15');
                        pigeon.setAttribute('animation', 'property: position; to: 12 6 -25; dur: 6000; easing: easeInOutQuad; loop: true');
                    } else if (id === 'clayPigeon3') {
                        pigeon.setAttribute('position', '-15 3 -10');
                        pigeon.setAttribute('animation', 'property: position; to: 5 8 -20; dur: 5000; easing: easeOutQuad; loop: true');
                    }
                });

                console.log("Game reset!");
            }

            document.addEventListener('gesturestart', function (e) {
            e.preventDefault(); // Disable gestures (like zoom)
        });

        document.addEventListener('dblclick', function (e) {
            e.preventDefault(); // Prevent double-click zoom
        });

        function startVR() {
            document.querySelector('.launch-screen').style.display = 'none';
            
            document.getElementById('shoot').style.display = 'block';
            document.getElementById('restart').style.display = 'block';
            document.getElementById('vrScene').style.display = 'block';

            const vrScene = document.getElementById('vrScene');

            // Once the scene has loaded, hide the loading screen and show the VR scene
            vrScene.addEventListener('loaded', function() {
                document.getElementById('loadingScreen').style.display = 'none';
                vrScene.style.display = 'block';
            });

            // Force loading of A-Frame assets
            vrScene.setAttribute('visible', 'true');
        };
        </script>
        <style>
            html, body {
                touch-action: manipulation; /* Disable gestures like double-tap zoom */
            }

            #shoot, #restart {
                position: absolute;
                bottom: 20px;
                z-index: 10;
                padding: 5px 10px;
                background-color: rgba(255, 255, 255, 0.4);
                border: 1px solid black;
                border-radius: 100px;
                width: 100px;
                height: 100px;
                cursor: pointer;
                font-size: larger;
            }
            
            #shoot {
                left: 35%;
            }
            
            #reset {
                left: 55%;
            }

            .launch-screen {
                height: 100%;
                margin: 0;
                display: flex;
                justify-content: center;
                align-items: center;
                background-color: #333;
                color: white;
                font-family: Arial, sans-serif;
                text-align: center;
            }

            .launch-screen div {
                text-align: center;
            }

            #startVRButton {
                padding: 10px 20px;
                background-color: #007BFF;
                border: none;
                color: white;
                cursor: pointer;
                font-size: 1.2em;
                border-radius: 5px;
            }

            #startVRButton:hover {
                background-color: #0056b3;
            }
        </style>
    </head>
    <body>
        <div class="launch-screen">
            <div>
                <h1>Welcome to the Skeet Shooting</h1>
                <p>Click the button below to start</p>
                <button id="startVRButton" onclick="startVR()">Start VR</button>
            </div>
        </div>
        <a-scene id="vrScene" style="display: none;">
            <a-assets>
                <a-asset-item id="shotgun" src="https://cdn.jsdelivr.net/gh/NeoAlchemy/skeet@main/assets/shotgun/shotgun.gltf"></a-asset-item>
                <a-asset-item id="clay-pigeon" src="https://cdn.jsdelivr.net/gh/NeoAlchemy/skeet@main/assets/clay-pigeon/scene.gltf" preload="auto"></a-asset-item>
                <audio id="clayPigeonBreak" src="https://cdn.jsdelivr.net/gh/NeoAlchemy/skeet@main/assets/sounds/clay-pigeon-breaking.wav" preload="auto"></audio>
                <audio id="skeetFire" src="https://cdn.jsdelivr.net/gh/NeoAlchemy/skeet@main/assets/sounds/skeet-fire.wav" preload="auto"></audio>
            </a-assets>
            
            <a-entity id="clayPigeonBreakEntity" sound="src: #clayPigeonBreak"></a-entity>
            <a-entity id="skeetFireEntity" sound="src: #skeetFire"></a-entity>
            <!-- Multiple clay pigeons with different animations -->
            <a-entity 
                id="clayPigeon1" 
                class="collidable" 
                gltf-model="#clay-pigeon" 
                position="-10 0 -20" 
                visible="true"
                animation__fall="property: position;
                    from: 0 20 -25; 
                    dur: 3000; 
                    easing: easeInOutQuad; 
                    to: 10 0 -30;
                    loop: true"
                animation__smaller="property: scale;
                    dur: 3000; 
                    to: 0.1 0.1 0.1;
                    loop: true" >
            </a-entity>
            <!-- <a-entity 
                id="clayPigeon1" 
                class="collidable" 
                gltf-model="#clay-pigeon" 
                position="-10 1 -20" 
                scale="0.01 0.01 0.01"
                visible="true"
                animation="property: position; to: 10 5 -30; dur: 4000; easing: linear; loop: true">
            </a-entity> --
            <a-entity 
              id="clayPigeon2" 
              class="collidable" 
              gltf-model="#clay-pigeon" 
              position="-15 2 -15" 
              material="color: orange"
              visible="true"
              animation="property: position; to: 15 6 -35; dur: 6000; easing: easeInOutQuad; loop: true"
              animation__smaller="property: scale; dur: 6000; to: 0.1 0.1 0.1; loop: true">
            </a-entity>

            <a-entity 
              id="clayPigeon3" 
              class="collidable" 
              gltf-model="#clay-pigeon" 
              position="-15 3 -10" 
              material="color: orange"
              visible="true"
              animation="property: position; to: 5 8 -20; dur: 5000; easing: easeOutQuad; loop: true">
            </a-entity> -->

            

            <!-- Camera with look-controls -->
            <a-entity camera look-controls position="0 1.6 0">
                <!-- Dot showing where raycaster is aiming -->
                <a-sphere id="aimDot" color="red" radius="0.01" position="0 0 -3" visible="true"></a-sphere>
                <a-entity 
                    id="raycasterEl" 
                    shotgun-raycaster
                    raycaster="objects: .collidable; far: 100; showLine: true; interval: 100" 
                    position="0 0 -1"> 
                </a-entity>
                <!-- Shotgun with raycaster to detect clayPigeons -->
                <a-entity 
                  gltf-model="#shotgun" 
                  rotation="-30 220 20"
                  position="0.5 -0.6 -1">
                </a-entity>
            </a-entity>
            
            <!-- Environment -->
            <a-entity environment="preset: forest; dressingAmount: 500"></a-entity>
        </a-scene>
        
        <!-- button -->
        <button id="shoot" style="display: none" onclick="shootClayPigeon()">Shoot</button>
        <button id="restart" style="display: none" onclick="resetGame()">Restart</button>
    </body>
</html>
